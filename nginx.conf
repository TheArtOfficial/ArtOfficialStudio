events { worker_connections 2048; }

http {
    client_max_body_size 1024M;


    # Main server - all services proxied through port 8080
    server {
        listen 8080;

        # ComfyUI
        location /workspace/ComfyUI/ {
            proxy_pass http://localhost:8188/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control no-cache;
        }

        # FluxGym
        location /fluxgym/ {
            proxy_pass http://localhost:7000/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control no-cache;
        }

        # Flux Model Downloader
        location /flux_model_downloader/ {
            proxy_pass http://localhost:5000/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Cache-Control no-cache;
        }

        # CivitAI Model Downloader
        location /civitai_model_downloader/ {
            proxy_pass http://localhost:5001/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Cache-Control no-cache;
        }

        # Diffusion Pipe UI (Gradio)
        location /diffusion_pipe_ui/ {
            proxy_pass http://localhost:7860/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control no-cache;
        }

        # JupyterLab
        location /jupyter/ {
            proxy_pass http://localhost:8888/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            add_header Cache-Control no-cache;
        }

        # TensorBoard
        location /tensorboard/ {
            proxy_pass http://localhost:6006/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            add_header Cache-Control no-cache;
        }

        # Access to directories
        location /files/workspace/ {
            alias /workspace/;
            autoindex on;
            autoindex_exact_size off;
        }

        location /files/models/ {
            alias /workspace/ComfyUI/models/;
            autoindex on;
            autoindex_exact_size off;
        }

        location /files/outputs/ {
            alias /workspace/ComfyUI/output/;
            autoindex on;
            autoindex_exact_size off;
        }

        # Default - redirect to ComfyUI
        location / {
            return 302 http://$host:8080/comfyui/;
        }
    }

    # Also expose services on their original ports for direct access
    # ComfyUI direct access
    server {
        listen 8188;
        location / {
            proxy_pass http://localhost:8188;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # JupyterLab direct access
    server {
        listen 8888;
        location / {
            proxy_pass http://localhost:8888;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }

    # Diffusion Pipe UI direct access
    server {
        listen 7860;
        location / {
            proxy_pass http://localhost:7860;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
        }
    }